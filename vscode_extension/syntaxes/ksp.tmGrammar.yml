#############################################################################
# This file is part of the vscode-ksp-compiler distribution
# (https://github.com/moosefriend/vscode-ksp-compiler).
#
# Copyright (c) 2024 MooseFriend (https://github.com/moosefriend)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, version 3.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
##############################################################################
# TextMate Grammar for KSP Script
# This file will be converted to out/ksp.tmGrammar.json
# Then the place holder <<...>> will be injected based on the *.csv files
scopeName: source.ksp

name: KSP

comment: NI Kontakt Script Syntax

fileTypes:
- ksp
- txt

patterns:
- include: '#pragma'
- include: '#macro'
- include: '#f_string'
- include: '#string'
- include: '#number'
- include: '#comment'
- include: '#callback'
- include: '#user_function'
- include: '#family'
- include: '#property'
- include: '#struct'
- include: '#const'
- include: '#constant'
- include: '#variable'
- include: '#ui_control'
- include: '#control_statement'
- include: '#operator'
- include: '#builtin_constant'
- include: '#builtin_command'
- include: '#other_keyword'
- include: '#identifier'

repository:
    # Extended Syntax
    pragma:
        patterns:
        - name: pragma.compiler.ksp
          comment: #pragma statement
          match: \{\s*#pragma\s+(save_compiled_source|preserve_names|compile_with(|out)\s+(remove_whitespace|compact_variables|combine_callbacks|extra_syntax_checks|extra_branch_optimization|optimize_code|add_compile_date|sanitize_exit_command|write_log_on_fail))\s*\}

    # Extended Syntax
    macro:
        patterns:
        -   name: macro.define.ksp
            comment: macro definition
            match: define\s+[a-z|A-Z][a-z|A-Z|0-9]\s*:=\s*(\S.*)$

    # Extended Syntax: F-String support f'...', with code highlighting inside <...>
    f_string:
        patterns:
        -   name: source.interpolated.f.ksp
            comment: f-string single quoted
            begin: "(f)(')"
            beginCaptures:
                '1':
                    name: keyword.other.ksp
                '2':
                    name: punctuation.definition.string.begin.ksp
            end: "'"
            endCaptures:
                '0':
                    name: punctuation.definition.string.end.ksp
            patterns:
                -   name: constant.character.escape.ksp
                    match: '\\.'
                -   name: meta.interpolation.ksp
                    begin: '<'
                    end: '>'
                    captures:
                        '0':
                            name: punctuation.section.interpolation.ksp
                    patterns:
                        # Recursively include all main patterns for code highlighting inside interpolation
                        - include: '#number'
                        - include: '#constant'
                        - include: '#variable'
                        - include: '#ui_control'
                        - include: '#operator'
                        - include: '#builtin_command'
                        - include: '#identifier'
                -   name: string.quoted.single.ksp
                    match: "[^'\\<]+"

    string:
        patterns:
        -   name: string.quoted.double.ksp
            comment: Double quoted string
            begin: '"'
            end: '"'
            captures:
                '0':
                    name: punctuation.definition.string.ksp
            patterns:
                -   name: constant.character.escape.ksp
                    match: '\\.'
        # Extended Syntax
        -   name: string.quoted.single.ksp
            comment: Single quoted string
            begin: "'"
            end: "'"
            captures:
                '0':
                    name: punctuation.definition.string.ksp
            patterns:
                -   name: constant.character.escape.ksp
                    match: '\\.'

    number:
        patterns:
        -   name: constant.numeric.float.ksp
            comment: Float number with leading number
            match: ((0|[1-9][0-9]*)\.[0-9]+)\b
        -   name: constant.numeric.float.ksp
            comment: Float number without leading number e.g. .314
            match: (\.[0-9]+)\b
        -   name: constant.numeric.dec.ksp
            comment: Decimal number
            match: ([0-9]+)\b
        -   name: constant.numeric.hex.ksp
            comment: Hexadecimal number, e.g. 3Fh
            match: ([0-9|a-f|A-F]+[hH])\b
        # Extended Syntax
        -   name: constant.numeric.hex.ksp
            comment: Hexadecimal number, e.g. 0x3F
            match: (0[xX]([0-9|a-f|A-F]+))\b
        -   name: constant.numeric.bin.ksp
            comment: Binary number, e.g. b0110
            match: (b[01]+)\b
        -   name: constant.numeric.bin.ksp
            comment: Binary number, e.g. 0110b
            match: ([01]+b)\b

    comment:
        patterns:
        # Extended Syntax
        -   name: comment.line.ksp
            comment: C-Style line commnet, e.g. // Comment
            match: (//).*$\n?
            captures:
                '1':
                    name: punctuation.definition.comment.ksp
        -   name: comment.block.ksp;
            comment: C-Style block comment, e.g. /* Comment */
            begin: /\*
            captures:
                '0':
                    name: punctuation.definition.comment.ksp
            end: \*/
        -   name: comment.block.ksp;
            comment: Pascal like block comment, e.g. (* Comment *)
            begin: \(\*
            captures:
                '0':
                    name: punctuation.definition.comment.ksp
            end: \*\)
        -   name: comment.block.ksp
            comment: Section comment
            begin: \{\{
            captures:
                '0':
                    name: punctuation.definition.comment.ksp
            end: \}\}
            contentName: section.comment.source.ksp
        # Standard Syntax
        -   name: comment.block.ksp
            comment: KSP comment
            begin: \{
            captures:
                '0':
                    name: punctuation.definition.comment.ksp
            end: \}

    callback:
        patterns:
        -   name: keyword.callback.begin.ksp
            comment: Built-in callbacks, e.g. on init
            # List of built_in_callbacks.csv column Name
            match: ^\s*on\s+(<<built_in_callbacks>>)\b
        -   name: keyword.callback.end.ksp
            comment: End of callback
            match: ^\s*end\s+on\b

    user_function:
        patterns:
        -   name: keyword.userfunction.end.ksp
            comment: End of user function
            match: ^\s*end\s+function\b
        -   name: keyword.userfunction.begin.ksp
            comment: User function definition
            match: ^\s*function\b

    # Extended Syntax
    constant:
        patterns:
        -   name: keyword.constant.block.end.ksp
            match: ^\s*end\s+const\b
        -   name: keyword.constant.block.begin.ksp
            match: ^\s*const\b

    # Extended Syntax
    struct:
        patterns:
        -   name: keyword.struct.block.end.ksp
            match: ^\s*end\s+struct\b
        -   name: keyword.struct.block.begin.ksp
            match: ^\s*struct\b

    # Extended Syntax
    family:
        patterns:
        -   name: keyword.family.block.end.ksp
            match: ^\s*end\s+family\b
        -   name: keyword.family.block.begin.ksp
            match: ^\s*family\b

    # Extended Syntax
    property:
        patterns:
        -   name: keyword.property.block.end.ksp
            match: ^\s*end\s+property\b
        -   name: keyword.property.block.begin.ksp
            match: ^\s*property\b

    variable:
        patterns:
        -   name: variable.other.ksp
            match: (\$|\~|\?|@|!|%)([0-9|a-z|A-Z|_]+)
        -   name: keyword.declare.ksp
            match: (declare|const|polyphonic)\b
        -   name: variable.preprocessor.ksp
            match: (SET_CONDITION|RESET_CONDITION|USE_CODE_IF|USE_CODE_IF_NOT|END_USE_CODE|NO_SYS_SCRIPT_GROUP_START|NO_SYS_SCRIPT_PEDAL|NO_SYS_SCRIPT_RLS_TRIG)\b

    ui_control:
        patterns:
        -   name: keyword.other.ui.ksp
            comment: Built-in widget
            # List of built_in_widgets.csv column Name
            match: (<<built_in_widgets>>)\b

    control_statement:
        patterns:
        -   name: keyword.other.statements.ksp
            match: (if|else|end\s+if|select|case|to|end\s+select|while|end\s+while|in_range)\b
        # Extended Syntax
        -   name: keyword.other.statements.ksp
            match: (for|downto|step|else\s+if)\b

    operator:
        patterns:
        -   name: keyword.other.arithmeticop.ksp
            match: (mod)\b
        -   name: keyword.other.boolop1.ksp
            match: (and|or|xor|not)\b
        -   name: keyword.other.bitop2.ksp
            match: (\.and\.|\.or\.|\.xor\.|\.not\.)\b
        # Extended syntax
        -   name: keyword.other.arrow.ksp
            match: ->

    # Extended Syntax
    builtin_constant:
        patterns:
        -   name: constant.time.ksp
            match: (__SEC__|__MIN__|__HOUR__|__HOUR12__|__AMPM__|__DAY__|__MONTH__|__YEAR__|__YEAR2__|__LOCALE_MONTH__|__LOCALE_MONTH_ABBR__|__LOCALE_DATE__|__LOCALE_TIME__)\b
    
    builtin_command:
        patterns:
        -   name: support.function.builtin.ksp
            comment: Build-in command or function
            # List of built_in_commands.csv column Name
            # List of built_in_functions.csv column Name
            match: (<<built_in_commands>>|<<built_in_functions>>)\b
        # Extended Syntax
        -   name: support.function.builtin.ksp
            match: (import_nckp|concat|import|START_INC|END_INC|set_bounds|set_slider_properties|set_button_properties|set_knob_properties|set_label_properties|set_level_meter_properties|set_menu_properties|set_switch_properties|set_table_properties|set_text_edit_properties|set_value_edit_properties|set_waveform_properties|set_wavetable2d_properties|set_wavetable3d_properties)\b

    other_keyword:
        patterns:
        -   name: keyword.other.ksp
            match: (on|end|function)\b
        # Extended Syntax
        -   name: keyword.other.ksp
            match: (pers|read|instpers|override|list)\b

    identifier:
        patterns:
        -   name: entity.name
            comment: Identifier
            match: ([a-z|A-Z|_]+[a-z|A-Z|_|0-9]*)
